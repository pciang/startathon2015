<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" />
    <title>Real-Time Baby Tracking</title>
</head>
<body>
    <div class="container">
        <h1>Accelerometer data</h1>
        <div id="accelerometer_chart">

        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript"
          src="https://www.google.com/jsapi?autoload={
            'modules':[{
              'name':'visualization',
              'version':'1',
              'packages':['corechart']
            }]
          }"></script>
    <div id="script-field"></div>
    <script type="text/javascript">
var startDate = new Date(0);
var endDate = new Date();
$(document).ready(function () {
    var scriptField = document.getElementById("script-field");

    function call() {
        (scriptField.appendChild(document.createElement("script"))).src = "http://localhost/startathon2015/retrieve.php?callback=ganteng&start_date=" + startDate.toMySQLString();
        setTimeout(call, 1000);
    }
    google.setOnLoadCallback(call);
});
var charts = [];
var lastEntryId = 0;
function pad(number) {
  if (number < 10) {
    return '0' + number;
  }
  return number;
}

Date.prototype.toMySQLString = function() {
  return this.getUTCFullYear() +
    '-' + pad(this.getUTCMonth() + 1) +
    '-' + pad(this.getUTCDate()) +
    ' ' + pad(this.getUTCHours()) +
    ':' + pad(this.getUTCMinutes()) +
    ':' + pad(this.getUTCSeconds());
};
function ganteng(json){
    console.log(json);
    drawChart();

    function drawChart() {
        if (lastEntryId === 0) charts.push(["Date & time", "AcX", "AcY", "AcZ", "GyX", "GyY", "GyZ", "Tmp", "Hum"]);

        for(var i = 0, size = json.length; i < size; ++i){
            var entry = json[i];
            if (lastEntryId > parseInt(entry.id, 10)) {
                break;
            }
            lastEntryId = parseInt(entry.id, 10);
            var t = entry.datetime.split(/[- :]/);
            //console.log(t);
            // +8, got bug, kthxbye
            startDate = new Date(t[0], t[1]-1, t[2], t[3]+8, t[4], t[5]);
            //console.log(startDate);
            //return;

            charts.push([entry.datetime, parseFloat(entry.acx), parseFloat(entry.acy)
                    , parseFloat(entry.acz), parseFloat(entry.gyx), parseFloat(entry.gyy)
                    , parseFloat(entry.gyz), parseFloat(entry.tmp), parseFloat(entry.hum)]);

        }

        var options = {
          title: 'Real-Time Baby Monitoring',
          curveType: 'function',
          legend: { position: 'bottom' },
          height: 500
        };
        // console.table(charts);

        new google.visualization.LineChart(document.getElementById('accelerometer_chart')).draw(
                google.visualization.arrayToDataTable(charts), options);
    }
}
    </script>
</body>
</html>